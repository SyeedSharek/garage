on:
  push:
    branches:
      - main # Deploy only when pushing to main branch
  pull_request:
    branches:
      - main # Run tests on PRs to main


name: üöÄ Deploy website on push

jobs:
  test:
    name: üß™ Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      # 1. Checkout the latest code
      - name: üöö Get latest code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: üõ† Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      # 4. Setup PHP (needed for Ziggy)
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, bcmath
          tools: composer:v2

      # 5. Validate PHP compatibility
      - name: üîç Validate PHP Compatibility
        run: |
          echo "Checking composer.lock for PHP 8.2 compatibility..."
          composer update
          composer install --dry-run --no-dev

      # 7. Build Frontend (after Ziggy is available)
      - name: üî® Build Frontend
        run: |
          npm install
          npm run build

      # 8. Prepare Laravel environment for testing
      - name: üõ† Prepare Laravel environment for testing
        run: |
          cp .env.example .env.testing
          echo "APP_KEY=base64:$(php -r 'echo base64_encode(random_bytes(32));')" >> .env.testing
          echo "DB_CONNECTION=sqlite" >> .env.testing
          echo "DB_DATABASE=database/database.sqlite" >> .env.testing
          echo "CACHE_DRIVER=array" >> .env.testing
          echo "QUEUE_CONNECTION=sync" >> .env.testing
          mkdir -p database
          touch database/database.sqlite

      # 9. Run database migrations (only if needed)
      - name: üóÑÔ∏è Run Database Migrations
        run: |
          ls

          # Only run migrations if there are pending migrations
          php artisan migrate:status | grep -q "Pending" && php artisan migrate --force || echo "No pending migrations"

  web-deploy:
    name: üéâ Deploy
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # 1. Checkout the latest code
      - name: üöö Get latest code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: üõ† Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      # 3. Setup PHP for code quality checks
      - name: üêò Setup PHP for Checks
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, bcmath
          tools: composer:v2

      # 5. Install PHP dependencies (required for Ziggy)
      - name: üì¶ Install Composer dependencies
        run: |
          composer update
          composer install --no-dev --optimize-autoloader

      # 6. Install Node.js dependencies & build
      - name: üî® Build Frontend
        run: |
          npm install
          npm run build
      # 7. Run database migrations (only if needed)
      - name: üóÑÔ∏è Run Database Migrations
        run: |

          # Only run migrations if there are pending migrations
          php artisan migrate:status | grep -q "Pending" && php artisan migrate --force || echo "No pending migrations"

      # 8. Prepare Laravel environment for deployment
      # - name: üõ† Prepare Laravel environment for deployment
      #   run: |
      #     # Create .env if it doesn't exist, otherwise preserve existing
      #     if [ ! -f .env ]; then
      #       cp .env.example .env
      #       echo "APP_KEY=base64:$(php -r 'echo base64_encode(random_bytes(32));')" >> .env
      #     fi

      #     # Temporarily override cache and queue for CI operations to avoid database dependency
      #     # Store original values
      #     export ORIGINAL_CACHE_STORE=$(grep "^CACHE_STORE=" .env | cut -d'=' -f2 || echo "database")
      #     export ORIGINAL_QUEUE_CONNECTION=$(grep "^QUEUE_CONNECTION=" .env | cut -d'=' -f2 || echo "database")

      #     # Temporarily set to array/sync for CI operations
      #     sed -i 's/^CACHE_STORE=.*/CACHE_STORE=array/' .env
      #     sed -i 's/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=sync/' .env

      #     # Create database directory for any potential SQLite operations
      #     mkdir -p database

      # 9. Laravel optimizations (safe for CI)
      - name: ‚ö° Laravel Optimize
        run: |
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          # php artisan cache:clear
          # Removed php artisan optimize to prevent path caching issues

          # Restore original cache and queue configuration
          # sed -i "s/^CACHE_STORE=.*/CACHE_STORE=$ORIGINAL_CACHE_STORE/" .env
          # sed -i "s/^QUEUE_CONNECTION=.*/QUEUE_CONNECTION=$ORIGINAL_QUEUE_CONNECTION/" .env

      # 9.1. Run migrations and cache configuration
      - name: üóÑÔ∏è Run Migrations & Cache Config
        run: |
          # Run migrations if there are pending migrations
          php artisan migrate:status | grep -q "Pending" && php artisan migrate --force || echo "No pending migrations"

          # Cache configuration for better performance
          php artisan config:cache

      # 10. Clear any cached files that might have wrong paths
      - name: üßπ Clear Cached Files
        run: |
          # Remove any cached files that might contain wrong paths
          rm -f bootstrap/cache/config.php
          rm -f bootstrap/cache/routes.php
          rm -f bootstrap/cache/services.php
          rm -f bootstrap/cache/packages.php

      # 11. Deploy via FTP
      - name: üìÇ Sync files to FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_HOST }}
          username: ${{ secrets.CPANEL_USERNAME }}
          password: ${{ secrets.CPANEL_PASSWORD }}
          method: ftp
          exclude: |
            **/node_modules/**
            **/vendor/**
            **/.git/**
            **/.github/**
            **/.env
            **/.cursor/**
            **/.kiro/**
            **/docs/**
            **/tests/**
          dangerous-clean-slate: false
          log-level: minimal
          dry-run: false
